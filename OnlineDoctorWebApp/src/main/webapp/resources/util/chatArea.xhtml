<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:composite="http://java.sun.com/jsf/composite"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

    <composite:interface>
        <composite:attribute name="startChatButtonValue" default="Start" />
        <composite:attribute name="stopChatButtonValue" default="Stop"/>
        <composite:attribute name="sendButtonValue" default="Send"/>
        <composite:attribute name="chatSessionId" required="true"/>
        <composite:attribute name="messageFrom" required="true"/>
        <composite:attribute name="messageTo" required="true" />

    </composite:interface>

    <composite:implementation>
        <h:outputScript name="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"/>
        <script>
            var wsocket;
            var serviceLocation = "ws://" + document.location.host + "/OnlineDoctorWebApp/chat/";
            var $nickName;
            var $message;
            var $chatWindow;
            var $room = '';
            function onMessageReceived(evt) {
                //var msg = eval('(' + evt.data + ')');
                alert("Msg received")
                var msg = JSON.parse(evt.data); // native API
                alert("Msg parsed");
                var $messageLine = '' + msg.received
                        + ' _' + msg.sender
                        + ' _' + msg.message
                        + '';

                alert(msg.received + " " + msg.sender + " " + msg.message);
                $chatWindow.append("\n" + $messageLine);
            }
            function sendMessage(evt) {
                alert("sendMessage() called");
                var messageArea= document.getElementById("message");
                var msg = '{"message":"' + messageArea.value + '", "sender":"#{cc.attrs.messageFrom}", "received":""}';
                alert(msg);
                wsocket.send(msg);
                messageArea.value="";
                messageArea.focus();
//                $message.val('message').focus();
            }

            function connectToChatserver() {
//room = $('#nickname').val();
                alert('connectToChatserver #{cc.attrs.chatSessionId}');
                alert('#{cc.attrs.chatSessionId}');
                alert('#{cc.attrs.chatSessionId}'+'eway');
                $room = '#{cc.attrs.chatSessionId}';
                alert("room"+ $room);
                wsocket = new WebSocket(serviceLocation + $room);
                wsocket.onmessage = onMessageReceived;
                return true;
            }

            function leaveRoom() {
                wsocket.close();
                $chatWindow.empty();
                $('.chat-wrapper').hide();
                $('.chat-signin').show();
                $nickName.focus();
            }

            $(document).ready(function () {
//    $nickName = $('#nickname');
                $message = $('#message');
                $chatWindow = $('#response');
                $('.chat-wrapper').hide();
//    $nickName.focus();
//    $('#chat-start').click(function (evt) {
//        evt.preventDefault();
//        alert("clicked");
//        connectToChatserver();
//        $('.chat-wrapper h2').text('Chat  @ channel' );
//        $('.chat-signin').hide();
//        $('.chat-wrapper').show();
//        $message.focus();
//    });
//    $('#do-chat').submit(function (evt) {
//        evt.preventDefault();
//        sendMessage()
//    });
//
//    $('#leave-room').click(function () {
//        leaveRoom();
//    });
            });

            function startChat(evt) {
                alert("startChat - clicked");
//        evt.preventDefault();

                if (connectToChatserver()) {
                    document.getElementById("leave-chat").setAttribute("hidden", false);
                    alert(document.getElementById("leave-chat").getAttribute("hidden"));
                    $('.chat-wrapper h2').text('chatting with '+'#{cc.attrs.messageTo}');
                    $('#chat-start').hide();
                    $('#leave-chat').show();
                    $message.focus();
                } else {
                    alert("couldn't connect to OnlineDoctor Chat server!");
                }
            }
        </script>

        <input type="button" id="chat-start"  value="#{cc.attrs.startChatButtonValue}" onclick="startChat();"  />
        <input type="button" id="leave-chat" value="#{cc.attrs.stopChatButtonValue}" onclick="stopChat()" />
        <div id="chat-wrapper"  class="chat-wrapper">
            <h2 >please #{cc.attrs.chatSessionId} #{cc.attrs.messageTo} #{cc.attrs.stopChatButtonValue}</h2>
            <!--<h:form id="do-chat" class="form-chat">-->
            <textarea id="response" rows="20" cols="100" readonly="true"/><br /><br />
            <textarea id="message" rows="3" cols="95"/>
            <input type="button" value="#{cc.attrs.sendButtonValue}" onclick="sendMessage()"/>

            <!--</h:form>-->
        </div>
    </composite:implementation>
</html>